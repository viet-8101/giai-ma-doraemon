<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giải mã Doraemon</title>
    <link rel="icon" href="Doraenon_logo.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google reCAPTCHA v2 (invisible) -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
    <style>
        /* CSS CƠ BẢN VÀ CHUNG */
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: url('doraemon-bg.jpg') no-repeat center center fixed; /* Đổi 'doraemon-bg.jpg' thành ảnh nền của bạn */
            background-size: cover;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Đảm bảo đủ chiều cao */
            overflow: hidden; /* Ngăn cuộn khi splash screen đang hoạt động */
        }

        /* Giao diện chính của ứng dụng */
        #mainContent {
            visibility: hidden; /* Ban đầu ẩn giao diện chính */
            opacity: 0; /* Cho hiệu ứng mờ dần khi hiện ra */
            transition: opacity 1s ease-in, visibility 1s ease-in; /* Thêm transition cho visibility */
            flex-direction: column; /* Để căn giữa nội dung overlay */
            justify-content: center;
            align-items: center;
            width: 100%; /* Chiếm toàn bộ chiều rộng để căn giữa overlay */
            height: 100vh;
        }
        #mainContent.visible {
            visibility: visible; /* Hiển thị lại khi splash screen ẩn */
            opacity: 1;
        }

        .overlay {
            background: rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 90%; /* Responsive width */
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            position: relative;
            box-sizing: border-box; /* Đảm bảo padding không làm tăng kích thước */
        }

        h1 {
            font-size: 2.4em;
            margin-bottom: 20px;
            color: white; /* Đảm bảo màu sắc hiển thị rõ ràng */
        }

    textarea {
      width: 70%;
      height: 70px;
      margin-bottom: 20px;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 1em;
      resize: none;
    }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
            gap: 12px; /* Khoảng cách giữa các nút */
            margin-bottom: 20px;
        }

        button {
            padding: 10px 18px;
            font-size: 1em;
            background: linear-gradient(270deg, #00bfff, #1e90ff, #ff69b4, #00fa9a, #00bfff);
            background-size: 1000% 1000%;
            animation: gradientFlow 10s ease infinite;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 180px;
            transition: transform 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }
        button:hover {
            transform: scale(1.05);
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #output {
            margin-top: 20px;
            font-size: 1.2em;
            white-space: pre-wrap;
            min-height: 40px;
            color: white;
        }

        #messageBox {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.95em;
            min-height: 25px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #messageBox.show {
            opacity: 1;
        }

        /* Microphone Indicator */
        .mic-indicator {
            width: 50px;
            height: 50px;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        .mic-indicator svg {
            width: 100%;
            height: 100%;
            fill: #00bfff;
            animation: micWave 1s infinite ease-in-out;
        }
        @keyframes micWave {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        #micText {
            margin-top: 10px;
            font-style: italic;
            display: none; /* Hidden by default */
            color: #ccc;
        }

        /* Settings Panel */
        .settings-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            color: white;
            transition: transform 0.5s ease-out;
            z-index: 10;
            /* Cài đặt mới cho icon bánh răng */
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40px; /* Kích thước icon */
            height: 40px;
            font-size: 2.2em; /* Kích thước icon bánh răng */
        }

        .settings-toggle.rotate {
            animation: rotate 0.5s ease-out forwards;
        }
        .settings-toggle.rotate-back {
            animation: rotate-back 0.5s ease-out forwards;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(180deg); } }
        @keyframes rotate-back { from { transform: rotate(180deg); } to { transform: rotate(0deg); } }

        .settings-panel {
            display: none; /* Hidden by default */
            position: absolute;
            top: 65px; /* Vị trí dưới nút cài đặt */
            right: 20px;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            flex-direction: column;
            gap: 10px;
            z-index: 9; /* Dưới nút toggle */
            min-width: 150px;
        }
        .settings-panel label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1em;
            color: #ccc;
        }
        .settings-panel input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
            accent-color: #00bfff; /* Màu checkbox */
        }
        .settings-panel button {
            background: linear-gradient(270deg, #00bfff, #1e90ff); /* Blueish gradient */
            color: white;
            padding: 10px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
            box-shadow: none; /* Remove default shadow for panel buttons */
            min-width: unset; /* Remove min-width from general button */
            margin-top: 5px; /* Add some space above buttons in settings */
        }
        .settings-panel button:hover {
            transform: none; /* No scale for panel buttons */
            background: linear-gradient(270deg, #1e90ff, #00bfff); /* Slightly darker */
        }

        /* Modal Styles */
        .modal {
            display: none; /* Đã sửa: Ban đầu ẩn modal để không hiện trước giao diện chính */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            /* Các thuộc tính quan trọng để căn giữa nội dung */
            justify-content: center; /* Căn giữa theo chiều ngang */
            align-items: center;     /* Căn giữa theo chiều dọc */
            animation: fadeInModal 0.3s ease-out;
        }
        .modal .close-btn {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-top: 20px; /* Space from content */
        }
        .modal .close-btn:hover {
            background-color: #d32f2f;
        }

        #modalLichSu .modal-content {
            background-color: #222;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 700px;
            max-height: 80vh; /* Giới hạn chiều cao */
            overflow-y: auto; /* Cho phép cuộn */
            color: white;
            display: flex; /* Dùng flex để dễ căn chỉnh nút đóng */
            flex-direction: column;
            align-items: center; /* Căn giữa nội dung và nút đóng */
        }
        #lichSuNoiDung {
            width: 100%; /* Chiếm toàn bộ chiều rộng của modal-content */
            text-align: left;
        }
        #lichSuNoiDung .history-item {
            background-color: #333;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            word-break: break-word; /* Đã đổi từ break-all sang break-word để trông tự nhiên hơn */
            border-left: 5px solid #00bfff; /* Màu xanh nước biển */
            position: relative;
            padding-right: 40px; /* Đủ chỗ cho nút xóa */
        }
        #lichSuNoiDung .delete-item-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #lichSuNoiDung .delete-item-btn:hover {
            background-color: #d32f2f;
        }

        /* Confirmation Modal Content Styles */
        /* Đặt các style của hộp thoại xác nhận vào #confirmModalContent (phần tử con của .modal) */
        #confirmModalContent {
            text-align: center;
            background: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.7);
            max-width: 350px;
            display: flex; /* Đảm bảo nội dung bên trong nó cũng là flex để sắp xếp các nút */
            flex-direction: column;
            gap: 20px;
        }
        #confirmModalContent p {
            font-size: 1.1em;
            margin: 0;
            color: white;
        }
        #confirmModalContent .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        #confirmModalContent .confirm-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-width: 100px;
        }
        #confirmModalContent .confirm-buttons button.cancel-btn {
            background: #6c757d; /* Gray */
            color: white;
        }
        #confirmModalContent .confirm-buttons button.cancel-btn:hover {
            background: #5a6268;
        }
        #confirmModalContent .confirm-buttons button.continue-btn {
            background: #dc3545; /* Red */
            color: white;
        }
        #confirmModalContent .confirm-buttons button.continue-btn:hover {
            background: #c82333;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ======================================= */
        /* CSS CHO SPLASH SCREEN MỚI - ĐÂY LÀ PHẦN QUAN TRỌNG NHẤT */
        /* ======================================= */

        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden; /* Quan trọng để các phần tách không tạo thanh cuộn */
            display: flex; /* Để căn giữa nội dung */
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Luôn nằm trên cùng */
            /* Nền gradient cho màn hình chính của splash screen, sẽ hiển thị sau khi blackScreenOverlay mờ đi */
            background: linear-gradient(270deg, #00bfff, #1e90ff, #ff69b4, #00fa9a, #00bfff);
            background-size: 1000% 1000%;
            animation: gradientFlow 15s ease infinite; /* Giữ animation nền */
        }

        /* Màn hình đen ban đầu */
        #blackScreenOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 10002; /* Trên tên, dưới các phần tách */
            opacity: 1;
            animation: blackScreenFadeOut 2s linear forwards; /* Mờ dần trong 2s */
            animation-delay: 0s; /* Bắt đầu ngay lập tức */
        }

        /* Container cho tên và subtitle */
        #myNameContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Căn giữa */
            z-index: 10001; /* Dưới màn hình đen và các phần tách */
            opacity: 0; /* Ban đầu ẩn */
            color: white;
            font-family: 'Arial Black', sans-serif; /* Font nổi bật hơn */
            font-size: 4.5em; /* Kích thước to hơn */
            font-weight: bold;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
            /* Animation: hiện ra (2-4s) và mờ đi (4-6s) */
            animation:
                myNameFadeInScale 2s ease-out 2s forwards,
                myNameFadeOutScale 2s ease-in 4s forwards;
            white-space: nowrap; /* Giữ tên trên một dòng nếu có thể */
            padding: 0 10px; /* Đảm bảo tên không bị tràn ra ngoài màn hình quá sát lề */
            box-sizing: border-box;
            text-align: center; /* Căn giữa nội dung bên trong */
        }
        #myNameContainer .my-name {
            display: inline-block; /* Để áp dụng transform và animation tốt hơn */
        }
        
        /* ✅ CSS SUBTITLE */
        .intro-subtitle {
            font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
            font-size: 0.3em; /* Kích thước tương đối so với tên */
            font-weight: normal;
            display: block; /* Hiển thị ở dòng mới */
            margin-top: 15px; /* Khoảng cách với tên */
            color: #f0f8ff; /* Màu trắng sáng (AliceBlue) */
            letter-spacing: 1px;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
            /* Animation cho subtitle */
            opacity: 0;
            animation: subtitleFadeIn 2s ease-out 2.5s forwards, /* Hiện ra sau tên một chút */
                         subtitleFadeOut 2s ease-in 4s forwards; /* Mờ đi cùng lúc với tên */
        }
        
        /* ✅ CSS CHO NÚT SKIP */
        #skipButton {
            position: absolute;
            bottom: 30px;
            right: 30px;
            padding: 10px 25px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid white;
            border-radius: 50px;
            cursor: pointer;
            z-index: 10004; /* Nằm trên tất cả các lớp khác của splash screen */
            opacity: 0; /* Ban đầu ẩn */
            visibility: hidden; /* Ẩn hoàn toàn */
            transition: all 0.4s ease-in-out;
            animation: skipButtonFadeIn 1s ease-out 2s forwards; /* Hiện ra sau 2 giây */
        }
        #skipButton:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Các phần chia */
        .split-part {
            position: absolute;
            width: 50vw; /* Chiếm 50% viewport width */
            height: 50vh; /* Chiếm 50% viewport height */
            opacity: 0; /* Ban đầu ẩn */
            /* Kế thừa nền gradient từ #splashScreen */
            background: linear-gradient(270deg, #00bfff, #1e90ff, #ff69b4, #00fa9a, #00bfff);
            background-size: 1000% 1000%; /* Giữ animation nền */
            /* Animation cho mỗi phần: xuất hiện, di chuyển, và mờ dần */
            animation:
                splitAppear 0s linear 6s forwards, /* Xuất hiện tại giây 6 */
                finalFadeOut 3s linear 7s forwards; /* Mờ dần từ giây 7-10 */
            z-index: 10003; /* Nằm trên cùng */
        }

        /* Vị trí ban đầu và animation di chuyển riêng của từng phần */
        .split-part.top-left {
            top: 0; left: 0;
            animation:
                splitAppear 0s linear 6s forwards, /* Xuất hiện tại giây 6 */
                splitMoveTopLeft 1s ease-out 6s forwards, /* Di chuyển ra từ giây 6-7 */
                finalFadeOut 3s linear 7s forwards; /* Mờ dần từ giây 7-10 */
        }
        .split-part.top-right {
            top: 0; left: 50vw;
            animation:
                splitAppear 0s linear 6s forwards,
                splitMoveTopRight 1s ease-out 6s forwards,
                finalFadeOut 3s linear 7s forwards;
        }
        .split-part.bottom-left {
            top: 50vh; left: 0;
            animation:
                splitAppear 0s linear 6s forwards,
                splitMoveBottomLeft 1s ease-out 6s forwards,
                finalFadeOut 3s linear 7s forwards;
        }
        .split-part.bottom-right {
            top: 50vh; left: 50vw;
            animation:
                splitAppear 0s linear 6s forwards,
                splitMoveBottomRight 1s ease-out 6s forwards,
                finalFadeOut 3s linear 7s forwards;
        }

        /* ================== */
        /* ĐỊNH NGHĨA KEYFRAMES */
        /* ================== */

        /* Nền gradient */
        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Màn hình đen mờ dần (0-2s) */
        @keyframes blackScreenFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        /* Tên hiện ra và phóng to (2-4s) */
        @keyframes myNameFadeInScale {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Tên mờ dần và thu nhỏ (4-6s) */
        @keyframes myNameFadeOutScale {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); visibility: hidden; }
        }
        
        /* ✅ KEYFRAMES cho SUBTITLE */
        @keyframes subtitleFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes subtitleFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* ✅ KEYFRAME cho NÚT SKIP */
        @keyframes skipButtonFadeIn {
            to {
                opacity: 1;
                visibility: visible;
            }
        }

        /* Các phần chia xuất hiện (tại giây 6) */
        @keyframes splitAppear {
            to { opacity: 1; }
        }

        /* Các phần chia di chuyển ra (6-7s) */
        @keyframes splitMoveTopLeft {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, -100%); } /* Di chuyển lên trái */
        }
        @keyframes splitMoveTopRight {
            0% { transform: translate(0, 0); }
            100% { transform: translate(100%, -100%); } /* Di chuyển lên phải */
        }
        @keyframes splitMoveBottomLeft {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 100%); } /* Di chuyển xuống trái */
        }
        @keyframes splitMoveBottomRight {
            0% { transform: translate(0, 0); }
            100% { transform: translate(100%, 100%); } /* Di chuyển xuống phải */
        }

        /* Mờ dần cuối cùng của các phần tách (7-10s) */
        @keyframes finalFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            button {
                padding: 10px 15px; /* Giảm padding ngang cho nút */
                font-size: 0.95em; /* Giảm font size cho nút */
                min-width: 150px; /* Điều chỉnh min-width để tránh tràn */
            }
            .overlay {
                padding: 25px 15px; /* Giảm padding ngang của overlay */
            }
            #myNameContainer {
                font-size: 3em; /* Nhỏ hơn trên di động */
                word-wrap: break-word; /* Cho phép ngắt từ nếu tên quá dài */
                white-space: normal; /* Cho phép xuống dòng */
                max-width: 90vw; /* Giới hạn chiều rộng để không tràn ra ngoài */
            }
            .intro-subtitle {
                font-size: 0.25em; /* Giảm size subtitle trên mobile */
            }
            #skipButton {
                font-size: 0.9em;
                padding: 8px 20px;
                bottom: 20px;
                right: 20px;
            }
            .settings-panel {
                right: 15px; /* Điều chỉnh vị trí panel */
                min-width: 130px;
            }
            .settings-panel button {
                font-size: 0.85em;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            textarea {
                height: 80px;
            }
            button {
                padding: 8px 12px; /* Giảm padding nhỏ hơn nữa */
                font-size: 0.85em; /* Giảm font size nhỏ hơn nữa */
                min-width: 130px; /* Điều chỉnh min-width chặt chẽ hơn */
            }
            .overlay {
                padding: 15px 10px; /* Giảm padding rất nhiều */
            }
            #myNameContainer {
                font-size: 1.8em; /* Nhỏ hơn nữa trên di động */
            }
            .intro-subtitle {
                font-size: 0.3em; /* Tăng lại một chút cho cân đối */
            }
            .button-group {
                gap: 8px; /* Giảm khoảng cách giữa các nút */
            }
        }
    </style>
</head>
<body>
    <div id="splashScreen">
        <div id="blackScreenOverlay"></div>
        <div id="myNameContainer">
            <span class="my-name">NGUYỄN ĐẮC HOÀNG VIỆT</span>
            <span class="intro-subtitle">✨ Chuẩn bị khám phá thế giới kỳ diệu của Doraemon... ✨</span>
        </div>
        <div class="split-part top-left"></div>
        <div class="split-part top-right"></div>
        <div class="split-part bottom-left"></div>
        <div class="split-part bottom-right"></div>
        <button id="skipButton" onclick="skipIntro()">Skip</button>
    </div>

    <div id="mainContent">
        <div class="overlay">
            <h1> 🔍  Giải mã Doraemon</h1>
            <textarea id="input" placeholder="Nhập mã troll ở đây..." onkeydown="chanEnter(event)"></textarea>
            <div class="button-group">
                <!-- Nút Giải mã Doraemon sẽ gọi hàm bao bọc để tích hợp bảo mật -->
                <button onclick="performDecodingWithSecurity()">🧠 Giải mã Doraemon</button>
                <button onclick="saoChep()"> 📋  Copy kết quả</button>
                <button onclick="startDictation()"> 🎤  Nhận diện giọng nói</button>
            </div>
            <div id="output"></div>
            <div id="messageBox"></div>
            <div class="mic-indicator" id="micIndicator">
                <svg viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zm5 8v3a5 5 0 0 1-10 0V9H5v3a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12V9z" />
                </svg>
            </div>
            <div id="micText">🎙️ Đang lắng nghe...</div>
            <div class="settings-toggle" onclick="toggleSettings()">
                <i class="fas fa-cog"></i>
            </div>
            <div class="settings-panel" id="settingsPanel">
                <label><input type="checkbox" id="toggleSound" onchange="toggleAudio()"> Tắt âm thanh nền</label>
                <!-- New audio controls within the settings panel -->
                <button onclick="playAudio('giao-huong')">🎵 Bản giao hưởng địa cầu</button>
                <button onclick="playAudio('com-ngon')">🎶 Bữa cơm ngon lành</button>
                <button onclick="openLichSu()"> 📜  Xem lịch sử</button>
                <button onclick="clearAllHistory()">🗑️ Xóa lịch sử</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modalLichSu" tabindex="-1">
        <div class="modal-content">
            <button class="close-btn" onclick="closeLichSu()">Đóng</button>
            <div id="lichSuNoiDung"></div>
        </div>
    </div>

    <div class="modal" id="confirmModal" tabindex="-1">
        <div id="confirmModalContent">
            <p id="confirmMessage">Bạn có chắc chắn muốn xóa toàn bộ lịch sử không?</p>
            <div class="confirm-buttons">
                <button class="cancel-btn" onclick="cancelConfirmation()">Quay lại</button>
                <button class="continue-btn" onclick="proceedConfirmation()">Tiếp tục</button>
            </div>
        </div>
    </div>

    <!-- reCAPTCHA v2 invisible container -->
    <div id="recaptcha-container"
         class="g-recaptcha"
         data-sitekey="6LfWt3grAAAAAMe7Q_tyRVpCUMzBLhBYzssjXn2I"
         data-callback="onRecaptchaSuccess"
         data-size="invisible">
    </div>

    <audio id="myAudio" loop muted>
        <source src="https://media.vocaroo.com/mp3/1mrXpaxv1jUB" type="audio/mpeg">
    </audio>
    <audio id="typeSound" preload="auto">
        <source src="https://cdn.pixabay.com/audio/2023/03/01/audio_2a802b1f48.mp3" type="audio/mpeg">
    </audio>
    <!-- New audio elements -->
    <audio id="com-ngon" preload="auto">
        <source src="https://media.vocaroo.com/mp3/1883Jz7Qz18d" type="audio/mpeg">
    </audio>
    <audio id="giao-huong" preload="auto">
        <source src="https://media.vocaroo.com/mp3/1mrXpaxv1jUB" type="audio/mpeg">
    </audio>

    <!-- FingerprintJS CDN -->
    <script src="https://openfpcdn.io/fingerprintjs/v4"></script>

    <script>
        const tuDienDoraemon = {
            "cái loa biết đi": "Jaian",
            "thánh chảnh": "Suneo",
            "cục nợ quốc dân": "Nobita",
            "trùm chém gió": "Suneo",
            "boss ăn vặt": "Doraemon",
            "siêu nhân gục ngã": "Nobita",
            "máy phát kẹo": "Doraemon",
            "ổ bom di động": "Jaian",
            "thánh phá đồ": "Nobita",
            "chuyên gia gây họa": "Nobita",
            "nhà tài trợ nước mắt": "mẹ Nobita",
            "lò luyện điểm 0": "lớp học của Nobita",
            "trùm thất tình": "Nobita",
            "đứa trẻ cuối cùng của mushika": "Micca",
            "máy ATM biết đi": "Doraemon",
            "trí tuệ nhân tạo có tâm": "Doraemon",
            "con tinh tinh": "Jaian",
            "con khỉ đột": "Jaian", "khỉ đột": "Jaian",
            "tinh tinh": "Jaian",
            "con cáo": "Suneo", "cáo": "Suneo",
            "bạch tuộc": "Noise",
            "quần dài": "2 con cá trắm đen đc làm ở Pháp rất là mắc tiền (của Suneo)",
            "mụ phù thủy": "mẹ của Nobita",
            "tên ngốc hậu đậu": "Nobita",
            "tên robinson phiền phức": "Nobita",
            "thiên tài ngủ": "Nobita",
            "diễn viên suất sắc": "Nobita",
            "bậc thầy năn nỉ": "Nobita",
            "thiên tài thắt dây": "Nobita",
            "tay vua súng": "Nobita",
            "xe buýt": "Nobita", "xe bus":
            "Nobita", "mèo máy": "Doraemon",
            "mỏ nhọn": "Suneo",
            "lồi rốn": "Jaian",
            "yên ắng": "nhà Shizuka",
            "hình tròn": "bánh rán dorayaki",
            "kẻ tham lam": "Jaian",
            "hai người nổi tiếng ham ăn": "Jaian và Suneo",
            "điểm đen": "điểm 0",
            "bàn tay vàng trong làng ngáo ngơ": "Nobita",
            "cục tạ quốc dân": "Nobita",
            "đại ca sân trường": "Jaian",
            "người mẫu sừng sỏ": "Suneo",
            "cô gái tắm mỗi tập": "Shizuka",
            "vua bánh rán": "Doraemon",
            "thánh cầu cứu": "Nobita",
            "người đến từ tương lai": "Doraemon",
            "cây ATM sống": "Doraemon",
            "lồng tiếng động đất": "Jaian",
            "diễn viên chính của bi kịch": "Nobita",
            "fan cuồng công nghệ": "Suneo",
            "kẻ lười biếng nhỏ bé": "Nobita",
            "chồn xanh nhỏ đáng yêu": "Doraemon",
            "bình yên trước cơn bão": "nhà Shizuka",
            "cậu bé sáo lạc điệu": "Nobita",
            "loa phóng thanh biết đi": "Jaian",
            "trùm phá nốt": "Nobita",
            "người cứu âm nhạc địa cầu": "Doraemon",
            "quái vật hút âm": "bào tử noise",
            "người bạn đến từ hành tinh âm nhạc": "Micca",
            "thánh phá bản nhạc": "Nobita",
            "cây sáo truyền thuyết": "cây sáo dọc của mushika",
            "bản nhạc giải cứu trái đất": "bản giao hưởng địa cầu",
            "phi công nghiệp dư": "Nobita",
            "vùng đất trong mơ": "Utopia",
            "cư dân đám mây": "người sống ở Utopia",
            "nhà trên trời view đẹp": "Utopia",
            "người bạn Utopia": "Sonya",
            "trùm điều khiển thời tiết": "quản lý Utopia",
            "mặt trăng bay lạc": "Utopia",
            "chuyến phiêu lưu trên trời": "hành trình của nhóm Nobita",
            "lâu đài mây thần bí": "trung tâm điều hành Utopia",
            "trùm chấn động bầu trời": "Suneo lái máy bay",
            "cậu bé bay không bằng lái": "Nobita",
            "thánh nhảy moonwalk ngoài vũ trụ": "Nobita",
            "chuyên gia té không trọng lực": "Nobita",
            "trạm vũ trụ di động": "tàu của Doraemon",
            "người bạn tai dài trên mặt trăng": "Luca",
            "cư dân mặt trăng bí ẩn": "tộc người Espal",
            "đội thám hiểm mặt trăng": "nhóm Nobita",
            "mặt trăng giả tưởng": "thế giới do bảo bối tạo ra",
            "cuộc chiến không trọng lực": "trận đấu trên mặt trăng",
            "lũ bạn ngoài hành tinh đáng yêu": "Luca và đồng bọn",
            "bầu trời đêm đầy ảo mộng": "khung cảnh mặt trăng",
            "cậu bé lười biếng nhất thành phố": "Nobita",
            "cậu bé xấu tính nhất thành phố": "Jaian",
            "nhạc sĩ vũ trụ": "Trupet",
            "nhà soạn nhạc vĩ đại": "Trupet",
            "người sáng tác giao hưởng địa cầu": "Trupet",
            "chủ nhân bản giao hưởng địa cầu": "Trupet",
            "nhà sáng tạo âm nhạc vũ trụ": "Trupet",
            "nhạc sĩ bảo vệ hòa bình âm nhạc": "Trupet",
            "rùa siêu tốc vũ trụ": "Moto",
            "rùa vũ trụ có mai thép": "Moto",
            "rùa siêu bền": "Moto",
            "tốc độ vũ trụ từ mai rùa": "Moto",
            "vũ trụ đua rùa": "Moto",
            "con rùa nhanh nhất trong không gian": "Moto",
            "viên đạn của đại bác không khí": "Moto"
        };
        let lastDecodedResult = "";
        let audioPlayedFirstTime = false; // Biến cờ để kiểm tra xem nhạc đã phát lần đầu chưa
        let pendingDeleteIndex = -1; // Biến để lưu trữ chỉ số của mục sẽ xóa
        let isDeletingAll = false; // Biến cờ để biết đang xóa toàn bộ hay xóa từng mục
        let splashTimer = null; // ✅ Biến để quản lý setTimeout

        // Biến để lưu trữ ID widget reCAPTCHA
        let recaptchaWidgetId; 

        // Hàm callback khi reCAPTCHA API được tải
        const onloadCallback = function() {
            recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
                'sitekey': '6LfWt3grAAAAAMe7Q_tyRVpCUMzBLhBYzssjXn2I',
                'callback': 'onRecaptchaSuccess',
                'size': 'invisible'
            });
        };

        // Hàm chính để thực hiện giải mã sau khi kiểm tra bảo mật
        async function performDecodingWithSecurity() {
            showMessage("Đang kiểm tra bảo mật...", "info");
            
            // 1. Kiểm tra reCAPTCHA
            try {
                await executeRecaptcha();
                console.log("reCAPTCHA kiểm tra thành công.");
            } catch (error) {
                console.error("Lỗi reCAPTCHA:", error);
                showMessage("Lỗi xác minh reCAPTCHA. Vui lòng thử lại.", "error");
                return;
            }

            // 2. Lấy thông tin IP
            await getIpInfo();

            // 3. Lấy Fingerprint
            await getVisitorId();

            // Nếu tất cả các bước bảo mật đều thành công, tiến hành giải mã
            giaiMa();
        }

        // --- 1. TÍCH HỢP GOOGLE RECAPTCHA V2 (INVISIBLE) ---
        function executeRecaptcha() {
            return new Promise((resolve, reject) => {
                if (typeof grecaptcha === 'undefined' || !recaptchaWidgetId) {
                    console.error("reCAPTCHA chưa sẵn sàng.");
                    return reject("reCAPTCHA_NOT_READY");
                }
                
                // Set a timeout for reCAPTCHA execution
                const timeout = setTimeout(() => {
                    reject("reCAPTCHA_TIMEOUT");
                }, 10000); // 10 seconds timeout

                // Define the success callback in the global scope (as required by reCAPTCHA)
                window.onRecaptchaSuccess = function(token) {
                    clearTimeout(timeout);
                    console.log("reCAPTCHA token:", token);
                    // Có thể gửi token này đến backend để xác minh thêm nếu có
                    resolve(token);
                    // Reset reCAPTCHA for future use
                    grecaptcha.reset(recaptchaWidgetId);
                };

                grecaptcha.execute(recaptchaWidgetId);
            });
        }


        // --- 2. TÍCH HỢP IPINFO API (LITE) ---
        async function getIpInfo() {
            const ipinfoToken = "97322fdbb8213c"; // Your IPInfo token
            try {
                const response = await fetch(`https://ipinfo.io/json?token=${ipinfoToken}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Thông tin IP:");
                console.log("  IP:", data.ip);
                console.log("  Quốc gia:", data.country);
                console.log("  Vùng:", data.region);
                console.log("  Tổ chức:", data.org);
                console.log("  Hostname:", data.hostname || "N/A"); // hostname có thể không có trong Lite plan
                
                // Ví dụ kiểm tra IP từ Việt Nam
                if (data.country && data.country !== "VN") {
                    console.warn("Người dùng truy cập từ ngoài Việt Nam:", data.country);
                    // Có thể thêm logic chặn hoặc cảnh báo tại đây
                    showMessage(`Cảnh báo: Truy cập từ ${data.country}.`, "info");
                }
            } catch (error) {
                console.error("Lỗi khi lấy thông tin IP:", error);
                showMessage("Không thể lấy thông tin IP.", "error");
            }
        }

        // --- 3. TÍCH HỢP FINGERPRINTJS ---
        async function getVisitorId() {
            try {
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                const visitorId = result.visitorId;
                console.log("Fingerprint Visitor ID:", visitorId);

                const storedVisitorId = localStorage.getItem("doraemonVisitorId");
                if (storedVisitorId) {
                    if (storedVisitorId !== visitorId) {
                        console.warn("Visitor ID mới phát hiện khác với lần trước:", visitorId);
                        showMessage("Phát hiện truy cập lạ!.", "info");
                        // Có thể thêm logic cảnh báo hoặc hành động khác ở đây
                    } else {
                        console.log("Visitor ID khớp với lần truy cập trước.");
                    }
                } else {
                    localStorage.setItem("doraemonVisitorId", visitorId);
                    console.log("Lưu Visitor ID mới:", visitorId);
                }
            } catch (error) {
                console.error("Lỗi khi lấy Fingerprint ID:", error);
                showMessage("Không thể lấy mã định danh người dùng.", "error");
            }
        }


        function showMessage(msg, type = 'info') {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = msg;
            msgBox.className = 'show';
            if (type === 'error') {
                msgBox.style.backgroundColor = 'rgba(220, 20, 60, 0.8)';
            } else if (type === 'success') {
                msgBox.style.backgroundColor = 'rgba(60, 179, 113, 0.8)';
            } else {
                msgBox.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            }
            if (msgBox.timer) clearTimeout(msgBox.timer);
            msgBox.timer = setTimeout(() => {
                msgBox.className = '';
                msgBox.textContent = '';
            }, 3000);
        }

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        function giaiMa() {
            const inputElement = document.getElementById("input");
            const outputElement = document.getElementById("output");
            const input = inputElement.value.trim().toLowerCase();

            if (!input) {
                showMessage(" ⚠️  Bạn chưa nhập gì cả!", "error");
                lastDecodedResult = "";
                outputElement.textContent = ""; // Clear previous output if any
                return;
            }

            let text = input;
            const original = text;

            // Clear current output and start typing animation with "Đang xử lý..."
            goChuTungKyTu(" ➡️  Đang xử lý...", "output", 30);

            // Give a short delay to allow "Đang xử lý..." to appear before actual processing
            setTimeout(() => {
                const entries = Object.entries(tuDienDoraemon).sort((a, b) => b[0].length - a[0].length);
                let replaced = false;
                for (const [k, v] of entries) {
                    const re = new RegExp(escapeRegExp(k), "gi");
                    if (text.match(re)) { // Check if the key exists in the text
                        text = text.replace(re, v);
                        replaced = true;
                    }
                }

                if (!replaced) { // If no replacement occurred
                    goChuTungKyTu(" ❓  Không tìm thấy từ khóa phù hợp.", "output", 30);
                    lastDecodedResult = "";
                } else {
                    goChuTungKyTu(" ➡️  Kết quả: " + text, "output", 30);
                    lastDecodedResult = text;

                    const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
                    // Add timestamp to history item
                    lichSu.unshift({
                        input: original,
                        output: text,
                        timestamp: new Date().toLocaleString('vi-VN')
                    });
                    localStorage.setItem("lichSuDoraemon", JSON.stringify(lichSu.slice(0, 20))); // Limit to 20 items
                }
            }, 500); // Small delay to let the processing message show
        }

        function goChuTungKyTu(text, elementId, speed) {
            const el = document.getElementById(elementId);
            const sound = document.getElementById("typeSound");
            // Stop any ongoing typing animation and clear content
            if (el.typingTimer) clearTimeout(el.typingTimer);
            el.textContent = "";

            let index = 0;
            function type() {
                if (index < text.length) {
                    el.textContent += text.charAt(index);
                    // Only play sound if not muted
                    if (!sound.muted) {
                        try {
                            sound.pause();
                            sound.currentTime = 0;
                            sound.play();
                        } catch (e) {
                            console.error("Lỗi khi phát âm thanh:", e);
                        }
                    }
                    el.typingTimer = setTimeout(type, speed);
                    index++;
                } else {
                    // Ensure sound is stopped after typing is complete
                    sound.pause();
                    sound.currentTime = 0;
                }
            }
            type();
        }

        function saoChep() {
            if (!lastDecodedResult) {
                showMessage(" ⚠️  Chưa có kết quả giải mã để sao chép!", "error");
                return;
            }
            navigator.clipboard.writeText(lastDecodedResult).then(() => {
                showMessage(" 📋  Đã sao chép kết quả!", "success");
            }).catch(err => {
                console.error('Không thể sao chép văn bản: ', err);
                showMessage('Có lỗi xảy ra khi sao chép. Vui lòng thử lại hoặc sao chép thủ công.', "error");
            });
        }

        let recognition;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'vi-VN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            function startDictation() {
                showMessage("🎙️ Đang lắng nghe...", "info");
                document.getElementById("micIndicator").style.display = "block";
                document.getElementById("micText").style.display = "block";
                recognition.start();

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById("input").value = transcript;
                    document.getElementById("micIndicator").style.display = "none";
                    document.getElementById("micText").style.display = "none";
                    showMessage(" ✅  Nhận diện giọng nói hoàn tất.", "success");
                    performDecodingWithSecurity(); // Gọi hàm bảo mật sau khi nhận diện giọng nói
                };

                recognition.onerror = function(event) {
                    console.error("Lỗi nhận diện giọng nói:", event.error);
                    showMessage(" ⚠️  Không nhận diện được, thử lại. Lỗi: " + event.error, "error");
                    document.getElementById("micIndicator").style.display = "none";
                    document.getElementById("micText").style.display = "none";
                };

                recognition.onend = function() {
                    document.getElementById("micIndicator").style.display = "none";
                    document.getElementById("micText").style.display = "none";
                };
            }
        } else {
            function startDictation() {
                showMessage(" ⚠️  Trình duyệt của bạn không hỗ trợ nhận diện giọng nói (Chỉ hoạt động tốt trên Chrome).", "error");
            }
        }

        function chanEnter(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                performDecodingWithSecurity(); // Gọi hàm bảo mật khi nhấn Enter
            }
        }

        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            // Sử dụng querySelector để chọn settings-toggle vì nó có thể có nhiều nội dung (icon hoặc img)
            const toggleButton = document.querySelector(".settings-toggle");
            if (panel.style.display === "flex") {
                panel.style.display = "none";
                toggleButton.classList.remove("rotate");
                toggleButton.classList.add("rotate-back");
            } else {
                panel.style.display = "flex";
                toggleButton.classList.remove("rotate-back");
                toggleButton.classList.add("rotate");
            }
        }

        function toggleAudio() {
            const muted = document.getElementById("toggleSound").checked;
            document.getElementById("myAudio").muted = muted;
            document.getElementById("typeSound").muted = muted;
            document.getElementById("com-ngon").muted = muted; // New: Mute/unmute "com-ngon"
            document.getElementById("giao-huong").muted = muted; // New: Mute/unmute "giao-huong"
            localStorage.setItem("doraemonSoundMuted", muted);

            // Nếu người dùng bật âm thanh và chưa phát lần nào, thử phát lại
            if (!muted && !audioPlayedFirstTime) {
                document.getElementById("myAudio").play().catch(error => {
                    console.log("Lỗi khi phát nhạc nền tự động (sau khi bỏ tắt tiếng):", error);
                });
                audioPlayedFirstTime = true; // Đánh dấu đã cố gắng phát
            }
        }

        // New function to play specific audio
        function playAudio(audioId) {
            const audio = document.getElementById(audioId);
            // Pause and reset other audios if they are playing
            ['myAudio', 'typeSound', 'com-ngon', 'giao-huong'].forEach(id => {
                const otherAudio = document.getElementById(id);
                if (otherAudio && otherAudio !== audio) {
                    otherAudio.pause();
                    otherAudio.currentTime = 0;
                }
            });

            if (audio) {
                audio.loop = true; // Set the audio to loop
                if (audio.paused) {
                    audio.play().catch(error => {
                        console.error("Error playing audio:", error);
                        showMessage("⚠️ Không thể phát âm thanh. Vui lòng tương tác trang trước.", "error");
                    });
                } else {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }
        }

        function openLichSu() {
            const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
            const box = document.getElementById("lichSuNoiDung");

            box.innerHTML = ''; // Clear previous content
            if (lichSu.length === 0) {
                box.innerHTML = '<p style="text-align: center; color: #ccc;"><i>Chưa có lịch sử.</i></p>';
            } else {
                lichSu.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.classList.add('history-item');
                    div.innerHTML = `<strong>(${item.timestamp})</strong><br>${item.input}  ➡️  ${item.output}`;

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = ' ❌ ';
                    deleteButton.classList.add('delete-item-btn');
                    deleteButton.onclick = (event) => {
                        event.stopPropagation(); // Prevent modal from closing if button is within it
                        showConfirmDeleteOne(idx);
                    };
                    div.appendChild(deleteButton);
                    box.appendChild(div);
                });
            }
            document.getElementById("modalLichSu").style.display = "flex";
        }

        function closeLichSu() {
            document.getElementById("modalLichSu").style.display = "none";
        }

        function showConfirmDeleteOne(index) {
            pendingDeleteIndex = index;
            isDeletingAll = false; // Ensure this is false for single delete
            document.getElementById("confirmMessage").textContent = "Bạn có chắc muốn xóa mục này khỏi lịch sử?";
            document.getElementById("confirmModal").style.display = "flex"; // Show the modal container
        }
        
        // Hàm này sẽ hiển thị hộp thoại xác nhận trước khi xóa toàn bộ lịch sử.
        function clearAllHistory() {
            const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
            if (lichSu.length === 0) {
                showMessage("📜 Lịch sử đang trống.", 'info');
                return;
            }
            isDeletingAll = true;
            pendingDeleteIndex = -1; // Đảm bảo không xóa nhầm mục đơn lẻ
            document.getElementById("confirmMessage").textContent = "Bạn có chắc chắn muốn xóa toàn bộ lịch sử không?";
            document.getElementById("confirmModal").style.display = "flex";
        }

        function proceedConfirmation() {
            if (isDeletingAll) {
                localStorage.removeItem("lichSuDoraemon");
                showMessage("🗑️ Đã xóa toàn bộ lịch sử!", "success");
                closeLichSu(); // Đóng modal lịch sử sau khi xóa
            } else if (pendingDeleteIndex !== -1) {
                const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
                lichSu.splice(pendingDeleteIndex, 1);
                localStorage.setItem("lichSuDoraemon", JSON.stringify(lichSu));
                showMessage("🗑️ Đã xóa mục khỏi lịch sử!", "success");
                pendingDeleteIndex = -1;
            }
            document.getElementById("confirmModal").style.display = "none"; // Ẩn modal xác nhận
            openLichSu(); // Cập nhật lại giao diện lịch sử
        }

        function cancelConfirmation() {
            pendingDeleteIndex = -1;
            isDeletingAll = false;
            document.getElementById("confirmModal").style.display = "none"; // Ẩn modal xác nhận
        }
        
        // ✅ HÀM KẾT THÚC INTRO (DÙNG CHO CẢ SKIP VÀ KHI HẾT GIỜ)
        function endIntro() {
            clearTimeout(splashTimer); // Xóa bộ đếm thời gian nếu có
            const splashScreen = document.getElementById("splashScreen");
            const mainContent = document.getElementById("mainContent");
            const myAudio = document.getElementById("myAudio");
            
            splashScreen.style.display = "none"; // Ẩn hoàn toàn splash screen
            mainContent.style.visibility = "visible";
            mainContent.style.display = "flex";
            mainContent.classList.add("visible");
            
            // Sau khi splash screen ẩn, cố gắng phát nhạc nếu chưa phát và không bị tắt tiếng
            if (!audioPlayedFirstTime && !myAudio.muted) {
                 myAudio.play().catch(error => {
                     console.log("Lỗi khi phát nhạc nền tự động (cần tương tác người dùng):", error);
                 });
            }
            audioPlayedFirstTime = true; // Đánh dấu là đã cố gắng phát nhạc
        }
        
        // ✅ HÀM CHO NÚT SKIP
        function skipIntro() {
            endIntro(); // Khi nhấn nút skip, cũng gọi endIntro để ẩn splash và hiển thị nội dung chính
            // Sau khi skip, đây được coi là một tương tác của người dùng, nên thử phát nhạc
            const myAudio = document.getElementById("myAudio");
            if (!audioPlayedFirstTime && !myAudio.muted) {
                myAudio.play().catch(error => {
                    console.log("Lỗi khi phát nhạc sau Skip (có thể do đã chạy ở endIntro hoặc chính sách trình duyệt):", error);
                });
                audioPlayedFirstTime = true;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const myAudio = document.getElementById("myAudio");
            const toggleSoundCheckbox = document.getElementById("toggleSound");
            const comNgonAudio = document.getElementById("com-ngon"); // Get new audio elements
            const giaoHuongAudio = document.getElementById("giao-huong");

            document.getElementById("typeSound").volume = 0.2; // Đặt âm lượng cho âm thanh gõ
            // Set volumes for new audio elements (optional, adjust as needed)
            comNgonAudio.volume = 0.5;
            giaoHuongAudio.volume = 0.5;

            const savedMuteState = localStorage.getItem("doraemonSoundMuted");
            if (savedMuteState === "true") {
                toggleSoundCheckbox.checked = true;
                myAudio.muted = true;
                document.getElementById("typeSound").muted = true;
                comNgonAudio.muted = true; // New: Mute on load if saved state is muted
                giaoHuongAudio.muted = true; // New: Mute on load if saved state is muted
            } else {
                toggleSoundCheckbox.checked = false;
                myAudio.muted = false;
                document.getElementById("typeSound").muted = false;
                comNgonAudio.muted = false; // New: Unmute on load
                giaoHuongAudio.muted = false; // New: Unmute on load
            }
            
            // Tổng thời gian của tất cả các animation là 10 giây (10000 ms)
            const totalAnimationDuration = 10000;
            // Sau khi tất cả các animation hoàn tất (10 giây), gọi hàm endIntro
            splashTimer = setTimeout(endIntro, totalAnimationDuration);

            // Thêm event listener cho bất kỳ tương tác nào trên tài liệu (click/tap)
            // Sự kiện này sẽ gỡ bỏ chính nó sau khi được kích hoạt lần đầu
            document.body.addEventListener('click', function firstInteractionPlay() {
                const myAudio = document.getElementById("myAudio");
                // Chỉ phát nếu chưa phát lần nào và không bị tắt tiếng
                if (!audioPlayedFirstTime && !myAudio.muted) {
                    myAudio.play().then(() => {
                        audioPlayedFirstTime = true; // Đánh dấu đã phát thành công
                        document.body.removeEventListener('click', firstInteractionPlay); // Gỡ bỏ listener sau khi phát
                    }).catch(error => {
                        console.log("Lỗi khi phát nhạc nền sau tương tác đầu tiên:", error);
                        // Có thể thêm một nút "Bật nhạc" nhỏ nếu muốn người dùng kích hoạt thủ công
                    });
                }
            }, { once: true }); // Dùng once: true để chỉ nghe sự kiện này một lần

            // Gắn lại sự kiện lắng nghe click toàn bộ document, đảm bảo nó luôn hoạt động
            document.addEventListener("click", function(e) {
                const panel = document.getElementById("settingsPanel");
                const toggle = document.querySelector(".settings-toggle"); // Sử dụng querySelector
                const modalLichSu = document.getElementById("modalLichSu"); // Get the history modal
                const confirmModal = document.getElementById("confirmModal"); // Get the confirmation modal

                // Logic đóng settings panel khi click ra ngoài, tránh đóng khi click vào các modal
                if (panel.style.display === "flex" &&
                    !panel.contains(e.target) &&
                    !toggle.contains(e.target) &&
                    !modalLichSu.contains(e.target) && // Exclude history modal
                    !confirmModal.contains(e.target)) { // Exclude confirmation modal
                    panel.style.display = "none";
                    toggle.classList.remove("rotate");
                    toggle.classList.add("rotate-back");
                }
            }, { once: false });
        });
        document.getElementById("toggleSound").addEventListener("change", toggleAudio);
    </script>
</body>
</html>
