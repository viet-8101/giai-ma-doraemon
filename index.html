<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·∫£i m√£ Doraemon</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: url('doraemon-bg.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .overlay {
            background: rgba(0, 0, 0, 0.1);
            max-width: 800px;
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        h1 {
            font-size: 2.4em;
            margin-bottom: 20px;
        }
        textarea {
            width: 70%;
            height: 70px;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-size: 1em;
            resize: none;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 18px;
            font-size: 1em;
            background: linear-gradient(270deg, #00bfff, #1e90ff, #ff69b4, #00fa9a, #00bfff);
            background-size: 1000% 1000%;
            animation: gradientFlow 10s ease infinite;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 180px;
            transition: transform 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }
        button:hover {
            transform: scale(1.05);
        }
        @keyframes gradientFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        #output {
            margin-top: 20px;
            font-size: 1.2em;
            white-space: pre-wrap;
            min-height: 40px;
        }
        .mic-indicator {
            width: 50px;
            height: 50px;
            margin: 20px auto;
            display: none;
        }
        .mic-indicator svg {
            width: 100%;
            height: 100%;
            fill: #00bfff;
            animation: micWave 1s infinite ease-in-out;
        }
        @keyframes micWave {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }
        #micText {
            margin-top: 10px;
            font-style: italic;
            display: none;
        }
        .settings-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 1.3em;
            transition: transform 0.5s ease-out; /* ƒê·∫£m b·∫£o transition m∆∞·ª£t m√† cho transform */
        }
        .settings-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 12px 18px;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            color: white;
            z-index: 101;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            display: none;
            flex-direction: column;
            gap: 10px;
            color: white;
            z-index: 999;
        }
        .modal .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal .close-btn {
            align-self: flex-end;
            background: crimson;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            color: white;
        }
        .modal .history-item button {
            background: #444;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        #messageBox {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.95em;
            min-height: 25px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #messageBox.show {
            opacity: 1;
        }

        /* Styles for the custom confirmation modal */
        #confirmModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 15px;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 20px;
            color: white;
            z-index: 1000; /* Higher than other modals */
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.7);
            max-width: 350px;
            text-align: center;
        }
        #confirmModal p {
            font-size: 1.1em;
            margin: 0;
        }
        #confirmModal .confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        #confirmModal .confirm-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-width: 100px;
        }
        #confirmModal .confirm-buttons button.cancel-btn {
            background: #6c757d; /* Gray */
            color: white;
        }
        #confirmModal .confirm-buttons button.cancel-btn:hover {
            background: #5a6268;
        }
        #confirmModal .confirm-buttons button.continue-btn {
            background: #dc3545; /* Red */
            color: white;
        }
        #confirmModal .confirm-buttons button.continue-btn:hover {
            background: #c82333;
        }

        /* NEW CSS for settings toggle rotation */
        .settings-toggle.rotate {
            animation: rotate 0.5s ease-out forwards;
        }

        .settings-toggle.rotate-back {
            animation: rotate-back 0.5s ease-out forwards;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(180deg); /* Xoay 180 ƒë·ªô (n·ª≠a v√≤ng) */
            }
        }

        @keyframes rotate-back {
            from {
                transform: rotate(180deg); /* B·∫Øt ƒë·∫ßu t·ª´ 180 ƒë·ªô n·∫øu ƒëang ·ªü tr·∫°ng th√°i m·ªü */
            }
            to {
                transform: rotate(0deg); /* Quay v·ªÅ 0 ƒë·ªô */
            }
        }
    </style>
</head>
<body>
    <div class="overlay">
        <h1>üîç Gi·∫£i m√£ Doraemon</h1>
        <textarea id="input" placeholder="Nh·∫≠p m√£ troll ·ªü ƒë√¢y..." onkeydown="chanEnter(event)"></textarea>
        <div class="button-group">
            <button onclick="giaiMa()">üß† Gi·∫£i m√£ Doraemon</button>
            <button onclick="saoChep()">üìã Copy k·∫øt qu·∫£</button>
            <button onclick="startDictation()">üé§ Nh·∫≠n di·ªán gi·ªçng n√≥i</button>
        </div>
        <div id="output"></div>
        <div id="messageBox"></div>

        <div class="mic-indicator" id="micIndicator">
            <svg viewBox="0 0 24 24">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zm5 8v3a5 5 0 0 1-10 0V9H5v3a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12V9z" />
            </svg>
        </div>
        <div id="micText">üéôÔ∏è ƒêang l·∫Øng nghe...</div>
        <div class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</div>
        <div class="settings-panel" id="settingsPanel">
            <label><input type="checkbox" id="toggleSound" onchange="toggleAudio()"> T·∫Øt √¢m thanh</label>
            <button onclick="openLichSu()">üìú Xem l·ªãch s·ª≠</button>
            <button onclick="showConfirmDeleteAll()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
        </div>
    </div>

    <div class="modal" id="modalLichSu">
        <button class="close-btn" onclick="closeLichSu()">ƒê√≥ng</button>
        <div id="lichSuNoiDung"></div>
    </div>

    <div class="modal" id="confirmModal">
        <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?</p>
        <div class="confirm-buttons">
            <button class="cancel-btn" onclick="cancelConfirmation()">Quay l·∫°i</button>
            <button class="continue-btn" onclick="proceedConfirmation()">Ti·∫øp t·ª•c</button>
        </div>
    </div>

    <audio id="myAudio" loop muted>
        <source src="https://media.vocaroo.com/mp3/1mrXpaxv1jUB" type="audio/mpeg">
    </audio>
    <audio id="typeSound" preload="auto">
        <source src="https://cdn.pixabay.com/audio/2023/03/01/audio_2a802b1f48.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        const tuDienDoraemon = {
            "c√°i loa bi·∫øt ƒëi": "Jaian",
            "th√°nh ch·∫£nh": "Suneo",
            "c·ª•c n·ª£ qu·ªëc d√¢n": "Nobita",
            "tr√πm ch√©m gi√≥": "Suneo",
            "boss ƒÉn v·∫∑t": "Doraemon",
            "si√™u nh√¢n g·ª•c ng√£": "Nobita",
            "m√°y ph√°t k·∫πo": "Doraemon",
            "·ªï bom di ƒë·ªông": "Jaian",
            "th√°nh ph√° ƒë·ªì": "Nobita",
            "chuy√™n gia g√¢y h·ªça": "Nobita",
            "nh√† t√†i tr·ª£ n∆∞·ªõc m·∫Øt": "m·∫π Nobita",
            "l√≤ luy·ªán ƒëi·ªÉm 0": "l·ªõp h·ªçc c·ªßa Nobita",
            "tr√πm th·∫•t t√¨nh": "Nobita",
            "ƒë·ª©a tr·∫ª cu·ªëi c√πng c·ªßa mushika": "Micca",
            "m√°y ATM bi·∫øt ƒëi": "Doraemon",
            "tr√≠ tu·ªá nh√¢n t·∫°o c√≥ t√¢m": "Doraemon",
            "con tinh tinh": "Jaian",
            "con kh·ªâ ƒë·ªôt": "Jaian", "kh·ªâ ƒë·ªôt": "Jaian",
            "tinh tinh": "Jaian",
            "con c√°o": "Suneo", "c√°o": "Suneo",
            "b·∫°ch tu·ªôc": "Noise",
            "qu·∫ßn d√†i": "2 con c√° tr·∫Øm ƒëen ƒëc l√†m ·ªü Ph√°p r·∫•t l√† m·∫Øc ti·ªÅn (c·ªßa Suneo)",
            "m·ª• ph√π th·ªßy": "m·∫π c·ªßa Nobita",
            "t√™n ng·ªëc h·∫≠u ƒë·∫≠u": "Nobita",
            "t√™n robinson phi·ªÅn ph·ª©c": "Nobita",
            "thi√™n t√†i ng·ªß": "Nobita",
            "di·ªÖn vi√™n su·∫•t s·∫Øc": "Nobita",
            "b·∫≠c th·∫ßy nƒÉn n·ªâ": "Nobita",
            "thi√™n t√†i th·∫Øt d√¢y": "Nobita",
            "tay vua s√∫ng": "Nobita",
            "xe bu√Ωt": "Nobita", "xe bus":
            "Nobita", "m√®o m√°y": "Doraemon",
            "m·ªè nh·ªçn": "Suneo",
            "l·ªìi r·ªën": "Jaian",
            "y√™n ·∫Øng": "nh√† Shizuka",
            "h√¨nh tr√≤n": "b√°nh r√°n dorayaki",
            "k·∫ª tham lam": "Jaian",
            "hai ng∆∞·ªùi n·ªïi ti·∫øng ham ƒÉn": "Jaian v√† Suneo",
            "ƒëi·ªÉm ƒëen": "ƒëi·ªÉm 0",
            "b√†n tay v√†ng trong l√†ng ng√°o ng∆°": "Nobita",
            "c·ª•c t·∫° qu·ªëc d√¢n": "Nobita",
            "ƒë·∫°i ca s√¢n tr∆∞·ªùng": "Jaian",
            "ng∆∞·ªùi m·∫´u s·ª´ng s·ªè": "Suneo",
            "c√¥ g√°i t·∫Øm m·ªói t·∫≠p": "Shizuka",
            "vua b√°nh r√°n": "Doraemon",
            "th√°nh c·∫ßu c·ª©u": "Nobita",
            "ng∆∞·ªùi ƒë·∫øn t·ª´ t∆∞∆°ng lai": "Doraemon",
            "c√¢y ATM s·ªëng": "Doraemon",
            "l·ªìng ti·∫øng ƒë·ªông ƒë·∫•t": "Jaian",
            "di·ªÖn vi√™n ch√≠nh c·ªßa bi k·ªãch": "Nobita",
            "fan cu·ªìng c√¥ng ngh·ªá": "Suneo",
            "k·∫ª l∆∞·ªùi bi·∫øng nh·ªè b√©": "Nobita",
            "ch·ªìn xanh nh·ªè ƒë√°ng y√™u": "Doraemon",
            "b√¨nh y√™n tr∆∞·ªõc c∆°n b√£o": "nh√† Shizuka",
            "c·∫≠u b√© s√°o l·∫°c ƒëi·ªáu": "Nobita",
            "loa ph√≥ng thanh bi·∫øt ƒëi": "Jaian",
            "tr√πm ph√° n·ªët": "Nobita",
            "ng∆∞·ªùi c·ª©u √¢m nh·∫°c ƒë·ªãa c·∫ßu": "Doraemon",
            "qu√°i v·∫≠t h√∫t √¢m": "b√†o t·ª≠ noise",
            "ng∆∞·ªùi b·∫°n ƒë·∫øn t·ª´ h√†nh tinh √¢m nh·∫°c": "Micca",
            "th√°nh ph√° b·∫£n nh·∫°c": "Nobita",
            "c√¢y s√°o truy·ªÅn thuy·∫øt": "c√¢y s√°o d·ªçc c·ªßa mushika",
            "b·∫£n nh·∫°c gi·∫£i c·ª©u tr√°i ƒë·∫•t": "b·∫£n giao h∆∞·ªüng ƒë·ªãa c·∫ßu",
            "phi c√¥ng nghi·ªáp d∆∞": "Nobita",
            "v√πng ƒë·∫•t trong m∆°": "Utopia",
            "c∆∞ d√¢n ƒë√°m m√¢y": "ng∆∞·ªùi s·ªëng ·ªü Utopia",
            "nh√† tr√™n tr·ªùi view ƒë·∫πp": "Utopia",
            "ng∆∞·ªùi b·∫°n Utopia": "Sonya",
            "tr√πm ƒëi·ªÅu khi·ªÉn th·ªùi ti·∫øt": "qu·∫£n l√Ω Utopia",
            "m·∫∑t trƒÉng bay l·∫°c": "Utopia",
            "chuy·∫øn phi√™u l∆∞u tr√™n tr·ªùi": "h√†nh tr√¨nh c·ªßa nh√≥m Nobita",
            "l√¢u ƒë√†i m√¢y th·∫ßn b√≠": "trung t√¢m ƒëi·ªÅu h√†nh Utopia",
            "tr√πm ch·∫•n ƒë·ªông b·∫ßu tr·ªùi": "Suneo l√°i m√°y bay",
            "c·∫≠u b√© bay kh√¥ng b·∫±ng l√°i": "Nobita",
            "th√°nh nh·∫£y moonwalk ngo√†i v≈© tr·ª•": "Nobita",
            "chuy√™n gia t√© kh√¥ng tr·ªçng l·ª±c": "Nobita",
            "tr·∫°m v≈© tr·ª• di ƒë·ªông": "t√†u c·ªßa Doraemon",
            "ng∆∞·ªùi b·∫°n tai d√†i tr√™n m·∫∑t trƒÉng": "Luca",
            "c∆∞ d√¢n m·∫∑t trƒÉng b√≠ ·∫©n": "t·ªôc ng∆∞·ªùi Espal",
            "ƒë·ªôi th√°m hi·ªÉm m·∫∑t trƒÉng": "nh√≥m Nobita",
            "m·∫∑t trƒÉng gi·∫£ t∆∞·ªüng": "th·∫ø gi·ªõi do b·∫£o b·ªëi t·∫°o ra",
            "cu·ªôc chi·∫øn kh√¥ng tr·ªçng l·ª±c": "tr·∫≠n ƒë·∫•u tr√™n m·∫∑t trƒÉng",
            "l≈© b·∫°n ngo√†i h√†nh tinh ƒë√°ng y√™u": "Luca v√† ƒë·ªìng b·ªçn",
            "b·∫ßu tr·ªùi ƒë√™m ƒë·∫ßy ·∫£o m·ªông": "khung c·∫£nh m·∫∑t trƒÉng",
            "c·∫≠u b√© l∆∞·ªùi bi·∫øng nh·∫•t th√†nh ph·ªë": "Nobita",
            "c·∫≠u b√© x·∫•u t√≠nh nh·∫•t th√†nh ph·ªë": "Jaian",
            "nh·∫°c sƒ© v≈© tr·ª•": "Trupet",
            "nh√† so·∫°n nh·∫°c vƒ© ƒë·∫°i": "Trupet",
            "ng∆∞·ªùi s√°ng t√°c giao h∆∞·ªüng ƒë·ªãa c·∫ßu": "Trupet",
            "ch·ªß nh√¢n b·∫£n giao h∆∞·ªüng ƒë·ªãa c·∫ßu": "Trupet",
            "nh√† s√°ng t·∫°o √¢m nh·∫°c v≈© tr·ª•": "Trupet",
            "nh·∫°c sƒ© b·∫£o v·ªá h√≤a b√¨nh √¢m nh·∫°c": "Trupet",
            "r√πa si√™u t·ªëc v≈© tr·ª•": "Moto",
            "r√πa v≈© tr·ª• c√≥ mai th√©p": "Moto",
            "r√πa si√™u b·ªÅn": "Moto",
            "t·ªëc ƒë·ªô v≈© tr·ª• t·ª´ mai r√πa": "Moto",
            "v≈© tr·ª• ƒëua r√πa": "Moto",
            "con r√πa nhanh nh·∫•t trong kh√¥ng gian": "Moto",
            "vi√™n ƒë·∫°n c·ªßa ƒë·∫°i b√°c kh√¥ng kh√≠": "Moto"
        };

        let lastDecodedResult = "";
        let audioPlayedFirstTime = false;
        let pendingDeleteIndex = -1; // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ ch·ªâ s·ªë c·ªßa m·ª•c s·∫Ω x√≥a
        let isDeletingAll = false; // Bi·∫øn c·ªù ƒë·ªÉ bi·∫øt ƒëang x√≥a to√†n b·ªô hay x√≥a t·ª´ng m·ª•c

        function showMessage(msg, type = 'info') {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = msg;
            msgBox.className = 'show';
            if (type === 'error') {
                msgBox.style.backgroundColor = 'rgba(220, 20, 60, 0.8)';
            } else if (type === 'success') {
                msgBox.style.backgroundColor = 'rgba(60, 179, 113, 0.8)';
            } else {
                msgBox.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            }

            if (msgBox.timer) clearTimeout(msgBox.timer);
            msgBox.timer = setTimeout(() => {
                msgBox.className = '';
                msgBox.textContent = '';
            }, 3000);
        }

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        function giaiMa() {
            const input = document.getElementById("input").value.trim().toLowerCase();
            if (!input) {
                showMessage("‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p g√¨ c·∫£!", "error");
                lastDecodedResult = "";
                return;
            }

            let text = input;
            const original = text;
            goChuTungKyTu("‚û°Ô∏è ƒêang x·ª≠ l√Ω...", "output", 30);

            const entries = Object.entries(tuDienDoraemon).sort((a, b) => b[0].length - a[0].length);
            for (const [k, v] of entries) {
                const re = new RegExp(escapeRegExp(k), "gi");
                text = text.replace(re, v);
            }

            if (text === original) {
                goChuTungKyTu("‚ùì Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a ph√π h·ª£p.", "output", 30);
                lastDecodedResult = "";
            } else {
                goChuTungKyTu("‚û°Ô∏è K·∫øt qu·∫£: " + text, "output", 30);
                lastDecodedResult = text;
                const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
                lichSu.unshift({
                    input: original,
                    output: text
                });
                localStorage.setItem("lichSuDoraemon", JSON.stringify(lichSu.slice(0, 20)));
            }
        }

        function goChuTungKyTu(text, elementId, speed) {
            const el = document.getElementById(elementId);
            const sound = document.getElementById("typeSound");

            el.textContent = "";
            let index = 0;

            if (el.typingTimer) clearTimeout(el.typingTimer);

            function type() {
                if (index < text.length) {
                    el.textContent += text.charAt(index);
                    if (!sound.muted) {
                        try {
                            sound.pause();
                            sound.currentTime = 0;
                            sound.play();
                        } catch (e) {
                            console.error("L·ªói khi ph√°t √¢m thanh:", e);
                        }
                    }
                    el.typingTimer = setTimeout(type, speed);
                    index++;
                }
            }
            type();
        }

        function saoChep() {
            if (!lastDecodedResult) {
                showMessage("‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ gi·∫£i m√£ ƒë·ªÉ sao ch√©p!", "error");
                return;
            }
            navigator.clipboard.writeText(lastDecodedResult).then(() => {
                showMessage("üìã ƒê√£ sao ch√©p k·∫øt qu·∫£!", "success");
            }).catch(err => {
                console.error('Kh√¥ng th·ªÉ sao ch√©p vƒÉn b·∫£n: ', err);
                showMessage('C√≥ l·ªói x·∫£y ra khi sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c sao ch√©p th·ªß c√¥ng.', "error");
            });
        }

        let recognition;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'vi-VN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            function startDictation() {
                showMessage("üéôÔ∏è ƒêang l·∫Øng nghe...", "info");
                document.getElementById("micIndicator").style.display = "block";
                document.getElementById("micText").style.display = "block";
                recognition.start();
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById("input").value = transcript;
                    document.getElementById("micIndicator").style.display = "none";
                    document.getElementById("micText").style.display = "none";
                    showMessage("‚úÖ Nh·∫≠n di·ªán gi·ªçng n√≥i ho√†n t·∫•t.", "success");
                    giaiMa();
                };
                recognition.onerror = function(event) {
                    console.error("L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i:", event.error);
                    showMessage("‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c, th·ª≠ l·∫°i. L·ªói: " + event.error, "error");
                    document.getElementById("micIndicator").style.display = "none";
                    document.getElementById("micText").style.display = "none";
                };
                recognition.onend = function() {
                    document.getElementById("micIndicator").style.display = "none";
                    document.getElementById("micText").style.display = "none";
                };
            }
        } else {
            function startDictation() {
                showMessage("‚ö†Ô∏è Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i (Ch·ªâ ho·∫°t ƒë·ªông t·ªët tr√™n Chrome).", "error");
            }
        }

        function chanEnter(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                giaiMa();
            }
        }

        // UPDATED toggleSettings function for rotation
        function toggleSettings() {
            const panel = document.getElementById("settingsPanel");
            const toggleButton = document.querySelector(".settings-toggle"); // Get the settings button

            if (panel.style.display === "flex") {
                // If the panel is currently open, close it
                panel.style.display = "none";
                toggleButton.classList.remove("rotate"); // Remove the 'open' rotation class
                toggleButton.classList.add("rotate-back"); // Add the 'close' rotation class
            } else {
                // If the panel is currently closed, open it
                panel.style.display = "flex";
                toggleButton.classList.remove("rotate-back"); // Remove the 'close' rotation class
                toggleButton.classList.add("rotate"); // Add the 'open' rotation class
            }
        }

        function toggleAudio() {
            const muted = document.getElementById("toggleSound").checked;
            document.getElementById("myAudio").muted = muted;
            document.getElementById("typeSound").muted = muted;
            localStorage.setItem("doraemonSoundMuted", muted);
        }

        function openLichSu() {
            const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
            const box = document.getElementById("lichSuNoiDung");
            box.innerHTML = lichSu.map((item, idx) =>
                `<div class="history-item">${item.input} ‚û°Ô∏è ${item.output}
                    <button onclick="showConfirmDeleteOne(${idx})">‚ùå</button></div>`
            ).join('') || "<i>Ch∆∞a c√≥ l·ªãch s·ª≠.</i>";
            document.getElementById("modalLichSu").style.display = "flex";
        }

        function closeLichSu() {
            document.getElementById("modalLichSu").style.display = "none";
        }

        function showConfirmDeleteOne(index) {
            pendingDeleteIndex = index;
            isDeletingAll = false;
            document.getElementById("confirmMessage").textContent = "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c n√†y kh·ªèi l·ªãch s·ª≠?";
            document.getElementById("confirmModal").style.display = "flex";
        }

        function showConfirmDeleteAll() {
            isDeletingAll = true;
            document.getElementById("confirmMessage").textContent = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?";
            document.getElementById("confirmModal").style.display = "flex";
        }

        function proceedConfirmation() {
            if (isDeletingAll) {
                localStorage.removeItem("lichSuDoraemon");
                showMessage("üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠!", "success");
                closeLichSu();
            } else if (pendingDeleteIndex !== -1) {
                const lichSu = JSON.parse(localStorage.getItem("lichSuDoraemon") || "[]");
                lichSu.splice(pendingDeleteIndex, 1);
                localStorage.setItem("lichSuDoraemon", JSON.stringify(lichSu));
                showMessage("üóëÔ∏è ƒê√£ x√≥a m·ª•c kh·ªèi l·ªãch s·ª≠!", "success");
                pendingDeleteIndex = -1;
            }
            document.getElementById("confirmModal").style.display = "none";
            openLichSu(); // Refresh history display
        }

        function cancelConfirmation() {
            pendingDeleteIndex = -1;
            isDeletingAll = false;
            document.getElementById("confirmModal").style.display = "none";
        }

        document.addEventListener("click", function(e) {
            const panel = document.getElementById("settingsPanel");
            const toggle = document.querySelector(".settings-toggle");
            const modal = document.getElementById("modalLichSu");
            const confirmModal = document.getElementById("confirmModal");

            if (panel.style.display === "flex" && !panel.contains(e.target) && !toggle.contains(e.target) && !modal.contains(e.target) && !confirmModal.contains(e.target)) {
                panel.style.display = "none";
                toggle.classList.remove("rotate"); // Ensure it rotates back when clicking outside
                toggle.classList.add("rotate-back");
            }

            if (!audioPlayedFirstTime) {
                const audio = document.getElementById("myAudio");
                const toggleSoundCheckbox = document.getElementById("toggleSound");

                if (!toggleSoundCheckbox.checked) {
                    audio.muted = false;
                    audio.play().catch(error => {
                        console.log("L·ªói khi ph√°t nh·∫°c n·ªÅn:", error);
                    });
                }
                audioPlayedFirstTime = true;
            }
        }, { once: false });

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("typeSound").volume = 0.2;
            const savedMuteState = localStorage.getItem("doraemonSoundMuted");
            if (savedMuteState === "true") {
                document.getElementById("toggleSound").checked = true;
                document.getElementById("myAudio").muted = true;
                document.getElementById("typeSound").muted = true;
            } else {
                document.getElementById("toggleSound").checked = false;
                document.getElementById("myAudio").muted = false;
                document.getElementById("typeSound").muted = false;
            }
        });

        document.getElementById("toggleSound").addEventListener("change", toggleAudio);
    </script>
</body>
</html>
